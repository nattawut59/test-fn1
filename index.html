<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCare Reminder Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
:root {
    /* สีหลักเปลี่ยนเป็นสีส้ม/เหลืองเพื่อสื่อถึงยา */
    --primary-color: #FF9800;
    --primary-dark: #F57C00;
    --primary-light: #FFE0B2;
    --secondary-color: #2196F3;
    --success-color: #4CAF50;
    --warning-color: #FFC107;
    --danger-color: #F44336;
    --text-primary: #333333;
    --text-secondary: #757575;
    --light-gray: #f5f5f5;
    --border-radius: 12px;
    --box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

body {
    font-family: 'Sarabun', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f9f9f9;
    background-image: linear-gradient(135deg, #f9f9f9 0%, #e6f0ff 100%);
    min-height: 100vh;
    color: var(--text-primary);
}

.container {
    max-width: 1200px;
    margin: 30px auto;
    background: white;
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
}

/* ปรับปรุง Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(120deg, var(--primary-color), var(--primary-dark));
    padding: 25px 30px;
    border-radius: var(--border-radius);
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(255, 152, 0, 0.25);
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: -20px;
    right: -20px;
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
}

.header::after {
    content: '';
    position: absolute;
    bottom: -50px;
    left: 20%;
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 50%;
}

.header h1 {
    color: white;
    margin: 0;
    font-size: 28px;
    font-weight: 600;
    display: flex;
    align-items: center;
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.header h1 i {
    margin-right: 15px;
    font-size: 34px;
    background: rgba(255, 255, 255, 0.2);
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.header-buttons {
    display: flex;
    gap: 12px;
    position: relative;
    z-index: 1;
}

.user-info {
    display: flex;
    align-items: center;
    margin-left: auto;
    margin-right: 15px;
}

.user-info .avatar {
    width: 35px;
    height: 35px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
}

.user-info .avatar i {
    font-size: 18px;
    color: white;
}

.user-info .name {
    color: white;
    font-weight: 600;
}

/* ปรับปรุง Tabs */
.tabs {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.tab {
    padding: 14px 24px;
    background: #fff;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    color: var(--text-primary);
    font-weight: 600;
    font-size: 16px;
    transition: var(--transition);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
}

.tab i {
    font-size: 18px;
}

.tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--primary-color);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.tab:hover {
    background: #f9f9f9;
}

.tab:hover::after {
    transform: scaleX(0.5);
}

.tab.active {
    background: white;
    color: var(--primary-color);
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.tab.active::after {
    transform: scaleX(1);
}

/* ปรับปรุงปุ่ม */
button {
    padding: 12px 22px;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

button::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

button:active::after {
    opacity: 1;
    transform: scale(70, 70) translate(-50%);
    transition: all 0.6s ease-out;
}

.add-btn {
    background: var(--success-color);
    color: white;
}

.edit-btn {
    background: var(--warning-color);
    color: white;
}

.delete-btn {
    background: var(--danger-color);
    color: white;
}

.taken-btn {
    background: var(--primary-color);
    color: white;
}

button:hover {
    opacity: 0.95;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}

/* ปรับปรุง Form Container */
.form-container {
    margin: 25px 0;
    padding: 30px;
    background: white;
    border-radius: var(--border-radius);
    display: none;
    border: none;
    box-shadow: var(--box-shadow);
    animation: slideDown 0.4s ease-out;
    transform-origin: top center;
    position: relative;
    overflow: hidden;
}

.form-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-title {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    color: var(--primary-dark);
    font-size: 20px;
    font-weight: 600;
}

.form-title i {
    margin-right: 15px;
    font-size: 26px;
    background: rgba(255, 152, 0, 0.1);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    color: var(--primary-color);
}

.form-group {
    margin-bottom: 22px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 15px;
}

.form-container input,
.form-container select,
.form-container textarea {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-family: 'Sarabun', sans-serif;
    transition: var(--transition);
    font-size: 16px;
    background: #f9fafb;
}

.form-container input:focus,
.form-container select:focus,
.form-container textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.15);
    background: white;
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 25px;
}

/* ปรับปรุงตาราง */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    box-shadow: var(--box-shadow);
    border-radius: var(--border-radius);
    overflow: hidden;
}

th, td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
}

th {
    background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
    color: white;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
}

tbody tr {
    transition: var(--transition);
    background: white;
}

tbody tr:last-child td {
    border-bottom: none;
}

tbody tr:hover {
    background-color: rgba(255, 152, 0, 0.03);
}

/* ปรับปรุง Badge */
.status-badge {
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 14px;
    display: inline-block;
    text-align: center;
    min-width: 80px;
}

.status-pending {
    background: #FFF8E1;
    color: #FF9800;
    border: 1px solid rgba(255, 152, 0, 0.2);
}

.status-taken {
    background: #E8F5E9;
    color: #4CAF50;
    border: 1px solid rgba(76, 175, 80, 0.2);
}

/* Action Buttons in table */
.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.action-buttons button {
    padding: 8px 12px;
    font-size: 14px;
}

/* ปรับปรุง Alert */
.alert {
    padding: 16px;
    margin: 20px 0;
    border-radius: var(--border-radius);
    color: white;
    display: none;
    opacity: 0;
    transition: all 0.5s ease;
    position: relative;
    overflow: hidden;
}

.alert::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, rgba(255,255,255,0.1), transparent);
}

.alert-success {
    background-color: var(--success-color);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
}

.alert-error {
    background-color: var(--danger-color);
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.2);
}

.alert.show {
    display: flex;
    align-items: center;
    opacity: 1;
}

.alert i {
    margin-right: 15px;
    font-size: 22px;
    background: rgba(255, 255, 255, 0.2);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

/* Empty State */
.empty-state {
    padding: 50px 40px;
    text-align: center;
    color: var(--text-secondary);
    display: none;
    background: #f9fafb;
    border-radius: var(--border-radius);
    margin: 30px 0;
    border: 2px dashed #e0e0e0;
}

.empty-state i {
    font-size: 65px;
    color: #ccd1d9;
    margin-bottom: 20px;
    background: rgba(204, 209, 217, 0.2);
    width: 110px;
    height: 110px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin: 0 auto 20px auto;
}

.empty-state h3 {
    font-size: 22px;
    margin-bottom: 10px;
    color: var(--text-primary);
}

/* ปรับปรุง Dashboard Stats */
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background-color: white;
    border-radius: var(--border-radius);
    padding: 22px 20px;
    box-shadow: var(--box-shadow);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    border-bottom: 4px solid var(--primary-color);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: var(--primary-color);
    opacity: 0.7;
}

.stat-card:nth-child(2)::before {
    background: var(--secondary-color);
}

.stat-card:nth-child(3)::before {
    background: var(--success-color);
}

.stat-card:nth-child(4)::before {
    background: var(--warning-color);
}

.stat-card:nth-child(2) {
    border-bottom-color: var(--secondary-color);
}

.stat-card:nth-child(3) {
    border-bottom-color: var(--success-color);
}

.stat-card:nth-child(4) {
    border-bottom-color: var(--warning-color);
}

.stat-card i {
    font-size: 38px;
    margin-bottom: 15px;
    color: var(--primary-color);
    background: rgba(255, 152, 0, 0.1);
    width: 75px;
    height: 75px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.stat-card:nth-child(2) i {
    color: var(--secondary-color);
    background: rgba(33, 150, 243, 0.1);
}

.stat-card:nth-child(3) i {
    color: var(--success-color);
    background: rgba(76, 175, 80, 0.1);
}

.stat-card:nth-child(4) i {
    color: var(--warning-color);
    background: rgba(255, 193, 7, 0.1);
}

.stat-card .stat-value {
    font-size: 34px;
    font-weight: 700;
    margin-bottom: 5px;
    color: var(--text-primary);
}

.stat-card .stat-label {
    color: var(--text-secondary);
    font-size: 16px;
    font-weight: 500;
}

/* Section Animation */
.section {
    display: none;
    animation: fadeSlideIn 0.4s ease-out;
}

@keyframes fadeSlideIn {
    from { 
        opacity: 0;
        transform: translateY(10px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.section.active {
    display: block;
}

/* ปรับปรุง Loader */
.loader {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(255, 152, 0, 0.2);
    border-bottom-color: var(--primary-color);
    border-radius: 50%;
    display: block;
    margin: 40px auto;
    animation: rotation 1s ease-in-out infinite;
    display: none;
}

@keyframes rotation {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* สไตล์สำหรับส่วนแดชบอร์ด */
#dashboardSection {
    padding: 20px;
}

.chart-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (min-width: 768px) {
    .chart-grid {
        grid-template-columns: 1fr 1fr;
    }
}

.chart-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 20px;
    margin-bottom: 20px;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 15px;
    color: var(--primary-dark);
}

.chart-container {
    height: 300px;
    width: 100%;
    position: relative;
}

.dashboard-tips {
    list-style-type: disc;
    padding-left: 20px;
    margin-top: 10px;
}

.dashboard-tips li {
    margin-bottom: 8px;
    color: var(--text-secondary);
}

.dashboard-update-info {
    margin-top: 15px;
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    font-style: italic;
}

.text-center {
    text-align: center;
}

.mt-3 {
    margin-top: 15px;
}

/* แจ้งเตือนป๊อปอัพ */
.notification-popup {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background-color: var(--primary-color);
    color: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 15px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 400px;
    min-width: 300px;
}

.notification-popup.show {
    transform: translateY(0);
    opacity: 1;
}

.notification-popup .icon {
    font-size: 30px;
    background: rgba(255, 255, 255, 0.2);
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.notification-popup .content {
    flex: 1;
}

.notification-popup h3 {
    margin: 0 0 5px 0;
    font-size: 18px;
}

.notification-popup p {
    margin: 0;
    opacity: 0.9;
}

.notification-popup .actions {
    display: flex;
    gap: 10px;
    margin-top: 12px;
}

.notification-popup .actions button {
    padding: 8px 12px;
    font-size: 14px;
    white-space: nowrap;
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        margin: 15px;
        padding: 20px;
    }
    
    .header {
        flex-direction: column;
        padding: 20px;
        gap: 15px;
        text-align: center;
    }
    
    .header-buttons {
        width: 100%;
        justify-content: center;
    }
    
    .tabs {
        overflow-x: auto;
        padding-bottom: 5px;
        flex-wrap: nowrap;
    }
    
    .tab {
        white-space: nowrap;
        padding: 10px 15px;
    }
    
    .dashboard-stats {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-buttons button {
        width: 100%;
    }
    
    .stat-card {
        padding: 15px;
    }
    
    th, td {
        padding: 12px 10px;
    }
    
    th {
        font-size: 12px;
    }
    
    .form-container {
        padding: 20px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <img src="image/3fd1c95b-a26d-4896-b7f8-8f8f9015441a.jpg" alt="Dashboard" width="1200" height="444" style="display: block; margin: auto;">
        <div class="header">
            <h1><i class="fas fa-pills"></i> MediCare Reminder</h1>
            <div class="header-buttons">
                <button class="add-btn" onclick="toggleForm('medicationForm')"><i class="fas fa-plus"></i> เพิ่มยา</button>
                <button class="add-btn" onclick="toggleForm('reminderForm')"><i class="fas fa-bell"></i> เพิ่มการแจ้งเตือน</button>
                <button class="delete-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
            </div>
        </div>
        <div class="dashboard-stats">
            <div class="stat-card">
                <i class="fas fa-pills"></i>
                <div class="stat-value" id="totalMedications">0</div>
                <div class="stat-label">รายการยาทั้งหมด</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-bell"></i>
                <div class="stat-value" id="totalReminders">0</div>
                <div class="stat-label">การแจ้งเตือนทั้งหมด</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <div class="stat-value" id="medicationTaken">0</div>
                <div class="stat-label">ทานยาแล้ววันนี้</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-stopwatch"></i>
                <div class="stat-value" id="nextReminder">-</div>
                <div class="stat-label">การแจ้งเตือนถัดไป</div>
            </div>
        </div>

        <div class="alert alert-success" id="successAlert">
            <i class="fas fa-check-circle"></i>
            <span id="successMessage"></span>
        </div>

        <div class="alert alert-error" id="errorAlert">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorMessage"></span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showSection('medications')"><i class="fas fa-pills"></i> รายการยา</button>
            <button class="tab" onclick="showSection('reminders')"><i class="fas fa-bell"></i> การแจ้งเตือน</button>
            <button class="tab" onclick="showSection('dashboard')"><i class="fas fa-chart-bar"></i> แดชบอร์ด</button>
        </div>

        <div class="loader" id="loader"></div>

        <!-- Medications Section -->
        <div id="medicationsSection" class="section active">
            <div id="medicationForm" class="form-container">
                <div class="form-title">
                    <i class="fas fa-pills"></i>
                    <h3>ข้อมูลยา</h3>
                </div>
                <input type="hidden" id="medId">
                <div class="form-group">
                    <label>ชื่อยา *</label>
                    <input type="text" id="medName" required placeholder="ระบุชื่อยา">
                </div>
                <div class="form-group">
                    <label>ขนาดยา</label>
                    <input type="text" id="medDosage" placeholder="เช่น 500 mg, 5 ml">
                </div>
                <div class="form-group">
                    <label>คำแนะนำการใช้ยา</label>
                    <textarea id="medInstructions" rows="3" placeholder="เช่น ทานหลังอาหาร, ทานก่อนนอน"></textarea>
                </div>
                <div class="form-group">
                    <label>เวลาทานยา</label>
                    <input type="time" id="medTime">
                </div>
                <div class="form-actions">
                    <button class="add-btn" id="saveMedButton" onclick="saveMedication()"><i class="fas fa-save"></i> บันทึก</button>
                    <button class="delete-btn" onclick="toggleForm('medicationForm')"><i class="fas fa-times"></i> ยกเลิก</button>
                </div>
            </div>

            <div id="emptyMedications" class="empty-state">
                <i class="fas fa-pills"></i>
                <h3>ไม่พบข้อมูลยา</h3>
                <p>กรุณาเพิ่มข้อมูลยาของคุณ</p>
                <button class="add-btn" onclick="toggleForm('medicationForm')"><i class="fas fa-plus"></i> เพิ่มยา</button>
            </div>

            <table id="medicationsTable">
                <thead>
                    <tr>
                        <th>ชื่อยา</th>
                        <th>ขนาดยา</th>
                        <th>คำแนะนำ</th>
                        <th>เวลาทานยา</th>
                        <th>สถานะ</th>
                        <th>การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="medicationList"></tbody>
            </table>
        </div>
        <!-- Reminders Section -->
        <div id="remindersSection" class="section">
            <div id="reminderForm" class="form-container">
                <div class="form-title">
                    <i class="fas fa-bell"></i>
                    <h3>ตั้งค่าการแจ้งเตือน</h3>
                </div>
                <div class="form-group">
                    <label>เลือกยา *</label>
                    <select id="reminderMedication" required></select>
                </div>
                <div class="form-group">
                    <label>เวลาแจ้งเตือน *</label>
                    <input type="time" id="reminderTime" required>
                </div>
                    <div class="form-group">
                        <label>ช่องทางการแจ้งเตือน *</label>
                        <select id="notificationChannel" required>
                            <option value="application" selected>แอปพลิเคชัน</option>
                            <!-- ลบตัวเลือกอื่นออก หรือเพิ่มเฉพาะที่ backend รองรับ -->
                        </select>
                    </div>
                <div class="form-actions">
                    <button class="add-btn" onclick="saveReminder()"><i class="fas fa-save"></i> บันทึก</button>
                    <button class="delete-btn" onclick="toggleForm('reminderForm')"><i class="fas fa-times"></i> ยกเลิก</button>
                </div>
            </div>

            <div id="emptyReminders" class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <h3>ไม่พบข้อมูลการแจ้งเตือน</h3>
                <p>กรุณาเพิ่มการแจ้งเตือนทานยาของคุณ</p>
                <button class="add-btn" onclick="toggleForm('reminderForm')"><i class="fas fa-plus"></i> เพิ่มการแจ้งเตือน</button>
            </div>

            <table id="remindersTable">
                <thead>
                    <tr>
                        <th>ชื่อยา</th>
                        <th>เวลาแจ้งเตือน</th>
                        <th>ช่องทางการแจ้งเตือน</th>
                        <th>การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="reminderList"></tbody>
            </table>
        </div>
    </div>
<!-- แก้ไขส่วนของ Dashboard Section -->
<div id="dashboardSection" class="section">
    <div class="chart-grid">
        <div class="chart-card">
            <h3 class="chart-title">การกระจายตัวของยาตามเวลา</h3>
            <div class="chart-container">
                <canvas id="timeDistributionChart" height="300"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 class="chart-title">อัตราการทานยาวันนี้</h3>
            <div class="chart-container">
                <canvas id="adherenceChart" height="300"></canvas>
            </div>
            <div class="text-center mt-3">
                <p>อัตราการทานยาตามกำหนด: <span id="adherenceRate">0%</span></p>
            </div>
        </div>
    </div>
    <div class="chart-card">
        <h3 class="chart-title">แนวโน้มการทานยา 7 วันล่าสุด</h3>
        <div class="chart-container">
            <canvas id="dailyLogsChart" height="300"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <h3 class="chart-title">คำแนะนำการใช้แดชบอร์ด</h3>
        <ul class="dashboard-tips">
            <li><strong>การกระจายตัวของยาตามเวลา</strong> - แสดงจำนวนยาที่ต้องทานในแต่ละช่วงเวลา</li>
            <li><strong>อัตราการทานยาวันนี้</strong> - แสดงสัดส่วนยาที่ทานแล้วและยังไม่ได้ทานในวันนี้</li>
            <li><strong>แนวโน้มการทานยา</strong> - แสดงประวัติการทานยาย้อนหลัง 7 วัน</li>
        </ul>
        <p class="dashboard-update-info">ข้อมูลอัปเดตอัตโนมัติทุก 1 นาที</p>
    </div>
</div>

<!-- ส่วนแจ้งเตือนป๊อปอัพ -->
<div class="notification-popup" id="reminderPopup">
    <div class="icon">
        <i class="fas fa-pills"></i>
    </div>
    <div class="content">
        <h3>เตือนเวลาทานยา</h3>
        <p id="reminderMedName">ถึงเวลาทานยาของคุณแล้ว</p>
        <div class="actions">
            <button class="taken-btn" onclick="markMedicationTaken()">
                <i class="fas fa-check"></i> ทานแล้ว
            </button>
            <button class="delete-btn" onclick="dismissReminder()">
                <i class="fas fa-times"></i> เลื่อนไปก่อน
            </button>
        </div>
    </div>
</div>

        <!-- เพิ่มปุ่มควบคุมเสียง -->
        <div class="sound-toggle" id="soundToggle" onclick="toggleSound()">
            <i class="fas fa-volume-up"></i> เปิดเสียงแจ้งเตือน
        </div>
    </div>
</div>
<div class="notification-popup" id="reminderPopup">
    <div class="icon">
        <i class="fas fa-pills"></i>
    </div>
    <div class="content">
        <h3>เตือนเวลาทานยา</h3>
        <p id="reminderMedName">ถึงเวลาทานยาของคุณแล้ว</p>
        <div class="actions">
            <button class="taken-btn" onclick="markMedicationTaken()">
                <i class="fas fa-check"></i> ทานแล้ว
            </button>
            <button class="delete-btn" onclick="dismissReminder()">
                <i class="fas fa-times"></i> เลื่อนไปก่อน
            </button>
        </div>
    </div>
</div>

<!-- เพิ่มแท็กเสียง (ซ่อนไว้) -->
<audio id="reminderSound" preload="auto" src="notification-7-270142.mp3"></audio>
<!-- เพิ่มในส่วนของ head ใน index.html -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- JavaScript หลักของแอปพลิเคชัน -->
<script>
    // ตัวแปรหลักสำหรับเก็บข้อมูล
    const API_URL = 'http://localhost:3000';
    let medications = [];
    let reminders = [];
    let medicationLogs = [];
    
    // ตัวแปรสำหรับการแจ้งเตือน
    let soundEnabled = true;
    let activeReminders = [];
    let checkInterval;
    let lastTimeCheck = '';
    let notificationTimeout;
    
    // ฟังก์ชันเปิด/ปิดเสียง
    function toggleSound() {
        soundEnabled = !soundEnabled;
        const soundToggle = document.getElementById('soundToggle');
        
        if (soundEnabled) {
            soundToggle.innerHTML = '<i class="fas fa-volume-up"></i> เปิดเสียงแจ้งเตือน';
            soundToggle.classList.remove('muted');
            
            // ทดสอบเสียงสั้นๆ เมื่อเปิดเสียง
            testSound();
        } else {
            soundToggle.innerHTML = '<i class="fas fa-volume-mute"></i> ปิดเสียงแจ้งเตือน';
            soundToggle.classList.add('muted');
        }
        
        // บันทึกการตั้งค่าลง localStorage
        localStorage.setItem('medicareReminderSound', soundEnabled ? 'enabled' : 'disabled');
        console.log('ตั้งค่าเสียงแจ้งเตือน: ' + (soundEnabled ? 'เปิด' : 'ปิด'));
    }
    // ฟังก์ชันล็อกเอ้าท์
function logout() {
    if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
        // ล้าง token และข้อมูลผู้ใช้
        localStorage.removeItem('medicareToken');
        localStorage.removeItem('medicareUser');
        
        // แสดงข้อความแจ้งเตือน
        alert('ออกจากระบบสำเร็จ');
        
        // นำทางไปยังหน้าล็อกอิน
        window.location.href = 'login.html';
    }
}
// แทนที่ฟังก์ชันตรวจสอบ token ใน index.html
function checkAuthentication() {
    const token = localStorage.getItem('medicareToken');
    
    if (!token) {
        console.log('ไม่พบ token ในระบบ กำลังนำทางไปยังหน้าล็อกอิน');
        window.location.href = 'login.html';
        return false;
    }
    
    // ตรวจสอบ token กับเซิร์ฟเวอร์
    return new Promise((resolve, reject) => {
        fetch(`${API_URL}/verify-token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Token verification failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.error === false) {
                console.log('Token ถูกต้อง กำลังโหลดแอปพลิเคชัน');
                
                // แสดงข้อมูลผู้ใช้
                displayUserInfo();
                
                // โหลดข้อมูลเริ่มต้น
                loadInitialData();
                resolve(true);
            } else {
                throw new Error(data.message || 'Token verification failed');
            }
        })
        .catch(error => {
            console.error('Token verification error:', error);
            
            // ตรวจสอบว่า token หมดอายุหรือไม่
            if (error.message && error.message.includes('หมดอายุ')) {
                localStorage.removeItem('medicareToken');
                localStorage.removeItem('medicareUser');
                window.location.href = 'login.html?expired=true';
            } else {
                localStorage.removeItem('medicareToken');
                localStorage.removeItem('medicareUser');
                window.location.href = 'login.html';
            }
            resolve(false);
        });
    });
}
document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('เริ่มต้นแอปพลิเคชัน');
        const isAuthenticated = await checkAuthentication();
        
        if (!isAuthenticated) {
            console.log('ไม่ผ่านการยืนยันตัวตน ยกเลิกการโหลดแอปพลิเคชัน');
            return;
        }
        
        // เริ่มระบบแจ้งเตือน
        initNotificationSystem();
        
        // เพิ่มการทดสอบโดยกดปุ่ม F2
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F2') {
                console.log('กดปุ่ม F2 เพื่อทดสอบการแจ้งเตือน');
                testNotification();
            }
        });
        
        // ถ้าอยู่ในแท็บแดชบอร์ด ให้แสดงกราฟ
        if (document.getElementById('dashboardSection').classList.contains('active')) {
            renderDashboardCharts();
        }
    } catch (error) {
        console.error('Error during initial load:', error);
        showAlert('error', 'เกิดข้อผิดพลาดในการโหลดข้อมูลเริ่มต้น');
    }
});

// ฟังก์ชันเสริมสำหรับแสดงข้อมูลผู้ใช้
function displayUserInfo() {
    const userJson = localStorage.getItem('medicareUser');
    if (userJson) {
        try {
            const user = JSON.parse(userJson);
            if (user && user.name) {
                // สร้างอิลิเมนต์แสดงข้อมูลผู้ใช้ในส่วนหัว
                let userInfoElement = document.querySelector('.user-info');
                if (!userInfoElement) {
                    userInfoElement = document.createElement('div');
                    userInfoElement.className = 'user-info';
                    userInfoElement.innerHTML = `
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="name">${user.name}</div>
                    `;
                    
                    const headerButtons = document.querySelector('.header-buttons');
                    const header = document.querySelector('.header');
                    if (header && headerButtons) {
                        header.insertBefore(userInfoElement, headerButtons);
                    }
                } else {
                    userInfoElement.querySelector('.name').textContent = user.name;
                }
            }
        } catch (e) {
            console.error('เกิดข้อผิดพลาดในการแสดงชื่อผู้ใช้:', e);
        }
    }
}

// ฟังก์ชันโหลดข้อมูลเริ่มต้นทั้งหมด
// เพิ่มฟังก์ชัน loadInitialData
async function loadInitialData() {
    try {
        showLoader();
        
        // โหลดข้อมูลเรียงลำดับและรอให้แต่ละส่วนโหลดเสร็จก่อน
        // เพื่อป้องกันปัญหาการอ้างอิงข้อมูลที่ยังไม่โหลด
        const medsData = await loadMedications();
        if (!medsData || medsData.length === 0) {
            console.log('ไม่พบข้อมูลยา');
        }
        
        const remindersData = await loadReminders();
        if (!remindersData || remindersData.length === 0) {
            console.log('ไม่พบข้อมูลการแจ้งเตือน');
        }
        
        const logsData = await loadMedicationLogs();
        if (!logsData || logsData.length === 0) {
            console.log('ไม่พบประวัติการทานยา');
        }
        
        hideLoader();
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลเริ่มต้น:', error);
        showAlert('error', `เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`);
        hideLoader();
    }
}

// แก้ไขการเรียกฟังก์ชันเมื่อหน้าเว็บโหลดเสร็จ
document.addEventListener('DOMContentLoaded', () => {
    // ตรวจสอบการ Authentication ก่อนทำงานต่อ
    checkAuthentication();
});
    
    // ฟังก์ชันทดสอบเสียง
    function testSound() {
        const audio = document.getElementById('reminderSound');
        if (!audio) {
            console.error('ไม่พบแท็ก audio');
            return;
        }
        
        audio.volume = 0.5;
        audio.currentTime = 0;
        audio.loop = false;
        
        // เล่นเสียงสั้นๆ เพื่อยืนยันว่าเปิดอยู่
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.then(_ => {
                // เล่นเสียงสำเร็จ ให้หยุดหลังจาก 1 วินาที
                setTimeout(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    console.log('ทดสอบเสียงสำเร็จ');
                }, 1000);
            }).catch(error => {
                console.error('การเล่นเสียงล้มเหลว:', error);
                alert('กรุณาอนุญาตให้เว็บไซต์เล่นเสียงได้เพื่อรับการแจ้งเตือน');
            });
        }
    }
    
// แก้ไขฟังก์ชัน checkReminders
function checkReminders() {
    const now = new Date();
    const currentHours = now.getHours().toString().padStart(2, '0');
    const currentMinutes = now.getMinutes().toString().padStart(2, '0');
    const currentTime = `${currentHours}:${currentMinutes}`;
    
    // ควรเก็บ log น้อยลงในการทำงานจริง
    if (currentTime !== lastTimeCheck) {
        console.log('ตรวจสอบเวลา:', currentTime);
        lastTimeCheck = currentTime;
        
        // ตรวจสอบว่ามีการแจ้งเตือนในเวลาปัจจุบันหรือไม่
        if (!reminders || !Array.isArray(reminders) || reminders.length === 0) {
            return;
        }
        
        // กรองการแจ้งเตือนที่ตรงกับเวลาปัจจุบัน
        activeReminders = reminders.filter(reminder => {
            if (!reminder || !reminder.reminder_time) return false;
            
            // ดึงเฉพาะ ชั่วโมง:นาที
            const reminderTime = reminder.reminder_time.substring(0, 5);
            return reminderTime === currentTime;
        });
        
        // แสดงการแจ้งเตือนหากมีการแจ้งเตือนที่ใช้งานอยู่
        if (activeReminders.length > 0) {
            console.log('มีการแจ้งเตือน', activeReminders.length, 'รายการในเวลา', currentTime);
            showReminderNotification();
            
            // ใช้การแจ้งเตือนของเบราว์เซอร์ด้วยหากได้รับอนุญาต
            if ('Notification' in window && Notification.permission === 'granted') {
                const medication = medications.find(med => 
                    med && med.id === activeReminders[0].medication_id);
                const title = 'เตือนเวลาทานยา';
                const body = medication ? 
                    `ถึงเวลาทาน ${medication.name} แล้ว` : 
                    `ถึงเวลาทานยา ${activeReminders.length} รายการแล้ว`;
                    
                new Notification(title, { body });
            }
        }
    }
}
// ปรับปรุงการแสดงการแจ้งเตือน
function showReminderNotification() {
    if (activeReminders.length === 0) return;
    
    // ดึงข้อมูลการแจ้งเตือนแรกและยาที่เกี่ยวข้อง
    const firstReminder = activeReminders[0];
    const medication = medications.find(med => med && med.id === firstReminder.medication_id);
    const medicationName = medication ? medication.name : 'ไม่ระบุชื่อยา';
    
    console.log('แสดงการแจ้งเตือนสำหรับยา:', medicationName);
    
    // ดึงป๊อปอัพการแจ้งเตือน
    const popup = document.getElementById('reminderPopup');
    if (!popup) {
        console.error('ไม่พบป๊อปอัพแจ้งเตือน');
        return;
    }
    
    const medNameElement = document.getElementById('reminderMedName');
    if (!medNameElement) {
        console.error('ไม่พบอิลิเมนต์แสดงชื่อยา');
        return;
    }
    
    // เก็บรหัสยาสำหรับปุ่ม "ทานแล้ว"
    popup.dataset.medicationId = firstReminder.medication_id;
    
    // ตั้งค่าชื่อยาตามจำนวนการแจ้งเตือน
    if (activeReminders.length === 1) {
        medNameElement.textContent = `ถึงเวลาทาน ${medicationName} แล้ว`;
        if (medication && medication.dosage) {
            medNameElement.textContent += ` (${medication.dosage})`;
        }
    } else {
        medNameElement.textContent = `ถึงเวลาทานยา ${activeReminders.length} รายการแล้ว`;
    }
    
    // แสดงป๊อปอัพพร้อมแอนิเมชัน
    popup.classList.add('show');
    
    // เล่นเสียงหากเปิดใช้งาน
    if (soundEnabled) {
        playReminderSound();
    }
    
    // ตั้งเวลาให้ปิดโดยอัตโนมัติหลังจาก 2 นาที
    if (notificationTimeout) {
        clearTimeout(notificationTimeout);
    }
    
    notificationTimeout = setTimeout(() => {
        dismissReminder();
    }, 120000); // 2 นาที
}
async function saveReminder() {
    const medicationId = document.getElementById('reminderMedication').value;
    const time = document.getElementById('reminderTime').value;
    const channel = "application"; // กำหนดค่าคงที่เพื่อหลีกเลี่ยงปัญหา truncation
    
    // ตรวจสอบข้อมูลให้ถูกต้อง
    if (!medicationId) {
        showAlert('error', 'กรุณาเลือกยาที่ต้องการแจ้งเตือน');
        return;
    }
    
    if (!time) {
        showAlert('error', 'กรุณาระบุเวลาแจ้งเตือน');
        return;
    }

    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }
        
        console.log('กำลังส่งข้อมูลการแจ้งเตือน:', {
            medication_id: parseInt(medicationId),
            reminder_time: time,
            notification_channel: channel
        });
        
        const response = await fetch(`${API_URL}/reminders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                medication_id: parseInt(medicationId),
                reminder_time: time,
                notification_channel: channel
            })
        });

        let responseData;
        try {
            responseData = await response.json();
            console.log('ผลตอบกลับจาก API:', responseData);
        } catch (e) {
            console.error('ไม่สามารถแปลงข้อมูลตอบกลับเป็น JSON ได้:', e);
            throw new Error('ข้อมูลตอบกลับจากเซิร์ฟเวอร์ไม่ถูกต้อง');
        }
        
        if (!response.ok) {
            throw new Error(responseData.message || 'ไม่สามารถบันทึกการแจ้งเตือนได้');
        }

        await loadReminders();
        toggleForm('reminderForm');
        showAlert('success', 'บันทึกการแจ้งเตือนสำเร็จ');
        clearForm('reminderForm');
    } catch (error) {
        console.error('Error details:', error);
        
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        
        showAlert('error', `ไม่สามารถบันทึกการแจ้งเตือนได้: ${error.message || 'โปรดลองอีกครั้ง'}`);
    } finally {
        hideLoader();
    }
}
function initNotificationSystem() {
    console.log('เริ่มระบบแจ้งเตือน');
    
    // ตั้งค่าเวลาตรวจสอบล่าสุดเริ่มต้น
    const now = new Date();
    lastTimeCheck = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    // ตรวจสอบเริ่มต้น
    checkReminders();
    
    // ตั้งค่าช่วงเวลาตรวจสอบทุก 10 วินาที
    if (checkInterval) {
        clearInterval(checkInterval);
    }
    checkInterval = setInterval(checkReminders, 10000);
    
    // โหลดการตั้งค่าเสียงจาก localStorage
    const savedSoundSetting = localStorage.getItem('medicareReminderSound');
    if (savedSoundSetting === 'disabled') {
        soundEnabled = false;
        
        // อัปเดต UI ตามการตั้งค่า
        const soundToggle = document.getElementById('soundToggle');
        if (soundToggle) {
            soundToggle.innerHTML = '<i class="fas fa-volume-mute"></i> ปิดเสียงแจ้งเตือน';
            soundToggle.classList.add('muted');
        }
    }
    
    // ขออนุญาตแจ้งเตือน (สำหรับเบราว์เซอร์ที่รองรับ)
    if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        // ขออนุญาตเมื่อผู้ใช้มีปฏิสัมพันธ์กับหน้าเว็บ
        document.addEventListener('click', function requestNotification() {
            Notification.requestPermission().then(function(permission) {
                if (permission === 'granted') {
                    console.log('การแจ้งเตือนได้รับอนุญาตแล้ว');
                }
            });
            // Remove the event listener after first click
            document.removeEventListener('click', requestNotification);
        });
    }
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            console.log('กลับมาที่หน้าเว็บ กำลังตรวจสอบการแจ้งเตือน');
            checkReminders();
        }
    });
    
    console.log('เริ่มระบบแจ้งเตือนเรียบร้อยแล้ว');
}
function setupTabEventListeners() {
    const tabs = document.querySelectorAll('.tab');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Extract section name from onclick attribute
            const onclickAttr = this.getAttribute('onclick');
            if (!onclickAttr) return;
            
            const match = onclickAttr.match(/showSection\('(.+?)'\)/);
            if (!match) return;
            
            const sectionName = match[1];
            showSection(sectionName);
        });
    });
    
    console.log('ตั้งค่า event listeners สำหรับแท็บเรียบร้อยแล้ว');
}

// Call this function at DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    setupTabEventListeners();
});
    // แก้ไขฟังก์ชัน showSection ใน index.html
function showSection(sectionName) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    document.getElementById(`${sectionName}Section`).classList.add('active');
    
    // เลือกแท็บที่ตรงกับ sectionName
    const targetTab = document.querySelector(`.tab[onclick="showSection('${sectionName}')"]`);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // หากเปิดแท็บแดชบอร์ด ให้อัปเดตกราฟ
    if (sectionName === 'dashboard') {
        renderDashboardCharts();
    }
}
    // แสดงการแจ้งเตือนและเล่นเสียง
    function showReminderNotification() {
        if (activeReminders.length === 0) return;
        
        // หาชื่อยาจากการแจ้งเตือนแรก
        const firstReminder = activeReminders[0];
        const medication = medications.find(med => med && med.id === firstReminder.medication_id);
        const medicationName = medication ? medication.name : 'ไม่ระบุชื่อยา';
        
        console.log('แสดงการแจ้งเตือนสำหรับยา:', medicationName);
        
        // แสดงป๊อปอัพแจ้งเตือน
        const popup = document.getElementById('reminderPopup');
        if (!popup) {
            console.error('ไม่พบป๊อปอัพแจ้งเตือน');
            return;
        }
        
        const medNameElement = document.getElementById('reminderMedName');
        if (!medNameElement) {
            console.error('ไม่พบอิลิเมนต์แสดงชื่อยา');
            return;
        }
        
        // เก็บรหัสยาใน data attribute
        popup.dataset.medicationId = firstReminder.medication_id;
        
        // แสดงชื่อยา
        if (activeReminders.length === 1) {
            medNameElement.textContent = `ถึงเวลาทาน ${medicationName} แล้ว`;
        } else {
            medNameElement.textContent = `ถึงเวลาทานยา ${activeReminders.length} รายการแล้ว`;
        }
        
        // แสดงป๊อปอัพ
        popup.classList.add('show');
        
        // เล่นเสียงแจ้งเตือน (ถ้าเปิดอยู่)
        if (soundEnabled) {
            console.log('กำลังเล่นเสียงแจ้งเตือน');
            playReminderSound();
        } else {
            console.log('เสียงแจ้งเตือนถูกปิดอยู่');
        }
        
        // ตั้งเวลาให้ป๊อปอัพหายไปเองหลัง 1 นาที
        if (notificationTimeout) {
            clearTimeout(notificationTimeout);
        }
        
        notificationTimeout = setTimeout(() => {
            dismissReminder();
        }, 60000); // 60 วินาที
    }
    
    // เล่นเสียงแจ้งเตือน
    function playReminderSound() {
        const audio = document.getElementById('reminderSound');
        if (!audio) {
            console.error('ไม่พบแท็ก audio');
            return;
        }
        
        // ตั้งค่าเสียง
        audio.volume = 0.7;
        audio.loop = true;
        audio.currentTime = 0;
        
        // เล่นเสียง
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.then(_ => {
                console.log('เล่นเสียงแจ้งเตือนสำเร็จ');
            }).catch(error => {
                console.error('การเล่นเสียงล้มเหลว:', error);
                alert('กรุณาอนุญาตให้เว็บไซต์เล่นเสียงได้เพื่อรับการแจ้งเตือน');
            });
        }
    }
    
    // หยุดเสียงแจ้งเตือน
    function stopReminderSound() {
        const audio = document.getElementById('reminderSound');
        if (!audio) {
            console.error('ไม่พบแท็ก audio');
            return;
        }
        
        audio.pause();
        audio.currentTime = 0;
        console.log('หยุดเสียงแจ้งเตือน');
    }
    
    // กดปุ่มทานยาแล้ว
    function markMedicationTaken() {
        const popup = document.getElementById('reminderPopup');
        const medicationId = popup.dataset.medicationId;
        
        if (medicationId) {
            console.log('กดปุ่มทานยาแล้วสำหรับยา ID:', medicationId);
            // เรียกฟังก์ชัน markAsTaken ที่มีอยู่แล้ว
            markAsTaken(parseInt(medicationId));
        }
        
        // ปิดการแจ้งเตือน
        dismissReminder();
    }
    
    // ปิดการแจ้งเตือน
    function dismissReminder() {
        const popup = document.getElementById('reminderPopup');
        if (!popup) {
            console.error('ไม่พบป๊อปอัพแจ้งเตือน');
            return;
        }
        
        popup.classList.remove('show');
        stopReminderSound();
        
        if (notificationTimeout) {
            clearTimeout(notificationTimeout);
        }
        
        console.log('ปิดการแจ้งเตือน');
    }
    
    // เริ่มระบบแจ้งเตือน
    function initNotificationSystem() {
        console.log('เริ่มระบบแจ้งเตือน');
        
        // รับเวลาปัจจุบันตั้งต้น
        const now = new Date();
        lastTimeCheck = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        
        // เรียกใช้ฟังก์ชันตรวจสอบเวลาทันที
        checkReminders();
        
        // เรียกใช้ฟังก์ชันตรวจสอบเวลาทุก 10 วินาที
        checkInterval = setInterval(checkReminders, 10000);
        console.log('ตั้งค่าการตรวจสอบเวลาทุก 10 วินาที');
        
        // โหลดการตั้งค่าเสียงจาก localStorage
        const savedSoundSetting = localStorage.getItem('medicareReminderSound');
        if (savedSoundSetting === 'disabled') {
            // ถ้าเคยปิดเสียงไว้ ให้ทำการปิดเสียง
            soundEnabled = true; // ตั้งให้เป็น true ก่อนเพื่อให้ toggleSound ทำงานถูกต้อง
            toggleSound();
        }
        
        // ขออนุญาตการแจ้งเตือน (สำหรับเบราว์เซอร์ที่รองรับ)
        if ('Notification' in window) {
            // ขออนุญาตเมื่อผู้ใช้มีปฏิสัมพันธ์กับหน้าเว็บ
            document.addEventListener('click', function() {
                if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }, { once: true });
        }
        
        // ติดตั้ง event listener สำหรับการตรวจสอบเมื่อกลับมาที่แท็บ
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // เรียกตรวจสอบทันทีเมื่อกลับมาที่หน้าเว็บ
                console.log('กลับมาที่หน้าเว็บ กำลังตรวจสอบการแจ้งเตือน');
                checkReminders();
            }
        });
        
        console.log('เริ่มระบบแจ้งเตือนเรียบร้อยแล้ว');
    }

    // ทดสอบการแจ้งเตือนด้วยตนเอง (สำหรับการทดสอบ)
    function testNotification() {
        activeReminders = [];
        
        // สร้างการแจ้งเตือนทดสอบ
        if (medications.length > 0) {
            const testMed = medications[0];
            activeReminders.push({
                medication_id: testMed.id,
                reminder_time: "00:00" // เวลาไม่สำคัญสำหรับการทดสอบ
            });
            console.log('สร้างการแจ้งเตือนทดสอบสำหรับยา:', testMed.name);
            showReminderNotification();
        } else {
            console.error('ไม่มีรายการยาสำหรับทดสอบการแจ้งเตือน');
            alert('กรุณาเพิ่มรายการยาก่อนทดสอบการแจ้งเตือน');
        }
    }
    
    // เพิ่มการเรียกใช้ initNotificationSystem ในฟังก์ชัน DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            console.log('เริ่มต้นแอปพลิเคชัน');
            
            // โหลดข้อมูลเริ่มต้น
            await loadMedications();
            await loadReminders();
            await loadMedicationLogs();
            
            // เริ่มระบบแจ้งเตือน
            initNotificationSystem();
            
            // เพิ่มการทดสอบโดยกดปุ่ม F2
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F2') {
                    console.log('กดปุ่ม F2 เพื่อทดสอบการแจ้งเตือน');
                    testNotification();
                }
            });
            
            // Setup event listeners for forms และโค้ดเดิมอื่นๆ...
            
        } catch (error) {
            console.error('Error during initial load:', error);
            showAlert('error', 'เกิดข้อผิดพลาดในการโหลดข้อมูลเริ่มต้น');
        }
    });
    
    // ตรวจสอบเวลาทันทีเมื่อเวลาในอุปกรณ์เปลี่ยน
    window.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            // เรียกตรวจสอบทันทีเมื่อกลับมาที่หน้าเว็บ
            checkReminders();
        }
    });

    // Utility Functions
    function toggleForm(formId) {
        const form = document.getElementById(formId);
        form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
        
        if (form.style.display === 'block') {
            if (formId === 'reminderForm') {
                loadMedicationsForReminder();
            } else if (formId === 'medicationForm') {
                // Clear form when opening for new entry
                if (!document.getElementById('medId').value) {
                    clearForm('medicationForm');
                }
            }
        }
    }
    function loadMedicationsForReminder() {
    const selectElement = document.getElementById('reminderMedication');
    if (!selectElement) {
        console.error('Element with ID "reminderMedication" not found');
        return;
    }
    
    // Clear existing options
    selectElement.innerHTML = '';
    
    // Add default empty option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '-- เลือกยา --';
    selectElement.appendChild(defaultOption);
    
    // Add options for each medication
    if (medications && Array.isArray(medications)) {
        medications.forEach(med => {
            if (!med) return;
            
            const option = document.createElement('option');
            option.value = med.id;
            option.textContent = med.name + (med.dosage ? ` (${med.dosage})` : '');
            selectElement.appendChild(option);
        });
    }
    
    console.log('โหลดรายการยาสำหรับการตั้งค่าแจ้งเตือนเรียบร้อย');
}
    function showSection(sectionName) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById(`${sectionName}Section`).classList.add('active');
        
        // เลือกแท็บที่ตรงกับ sectionName
        const targetTab = document.querySelector(`.tab[onclick="showSection('${sectionName}')"]`);
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        // หากเปิดแท็บแดชบอร์ด ให้อัปเดตกราฟ
        if (sectionName === 'dashboard') {
            renderDashboardCharts();
        }
    }

    function clearForm(formId) {
        const form = document.getElementById(formId);
        if (form) {
            const elements = form.querySelectorAll('input, select, textarea');
            elements.forEach(element => {
                element.value = '';
            });
            
            if (formId === 'medicationForm') {
                document.getElementById('medId').value = '';
            }
        }
    }

    function showAlert(type, message) {
        const alert = document.getElementById(`${type}Alert`);
        const messageElement = document.getElementById(`${type}Message`);
        messageElement.textContent = message;
        alert.classList.add('show');
        
        setTimeout(() => {
            alert.classList.remove('show');
        }, 3000);
    }

    function showLoader() {
        document.getElementById('loader').style.display = 'block';
    }

    function hideLoader() {
        document.getElementById('loader').style.display = 'none';
    }

    // ฟังก์ชันอัปเดตสถิติบนแดชบอร์ด
    function updateDashboardStats() {
        if (!medications || !Array.isArray(medications)) {
            console.error('Medications is not defined or not an array');
            return;
        }
        
        if (!medicationLogs || !Array.isArray(medicationLogs)) {
            console.error('MedicationLogs is not defined or not an array');
            return;
        }
        
        if (!reminders || !Array.isArray(reminders)) {
            console.error('Reminders is not defined or not an array');
            return;
        }
        
        document.getElementById('totalMedications').textContent = medications.length;
        document.getElementById('totalReminders').textContent = reminders.length;
        
        // นับจำนวนยาที่ทานแล้ววันนี้
        const today = new Date().toISOString().split('T')[0]; // ดึงวันที่ปัจจุบัน (YYYY-MM-DD)
        const takenToday = medicationLogs.filter(log => {
            // ตรวจสอบว่า created_at หรือ confirmed_at มีค่าและเริ่มต้นด้วยวันที่ปัจจุบัน
            return log && 
                ((log.created_at && log.created_at.startsWith(today)) || 
                (log.confirmed_at && log.confirmed_at.startsWith(today)));
        }).length;
        
        document.getElementById('medicationTaken').textContent = takenToday;
        
        // Find next reminder
        if (reminders.length > 0) {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Sort reminders by time
            const sortedReminders = [...reminders].sort((a, b) => {
                if (!a.reminder_time || !b.reminder_time) return 0;
                
                const timeA = a.reminder_time.split(':');
                const timeB = b.reminder_time.split(':');
                
                if (timeA.length < 2 || timeB.length < 2) return 0;
                
                return (parseInt(timeA[0]) * 60 + parseInt(timeA[1])) - (parseInt(timeB[0]) * 60 + parseInt(timeB[1]));
            });
            
            // Find next reminder today
            const nextReminder = sortedReminders.find(reminder => {
                if (!reminder.reminder_time) return false;
                
                const reminderTime = reminder.reminder_time.split(':');
                if (reminderTime.length < 2) return false;
                
                const reminderHour = parseInt(reminderTime[0]);
                const reminderMinute = parseInt(reminderTime[1]);
                
                return (reminderHour > currentHour) || (reminderHour === currentHour && reminderMinute > currentMinute);
            });
            
            if (nextReminder) {
                document.getElementById('nextReminder').textContent = nextReminder.reminder_time;
            } else if (sortedReminders.length > 0 && sortedReminders[0].reminder_time) {
                document.getElementById('nextReminder').textContent = sortedReminders[0].reminder_time;
            } else {
                document.getElementById('nextReminder').textContent = '-';
            }
        } else {
            document.getElementById('nextReminder').textContent = '-';
        }
    }

    // Medications Functions
    async function loadMedications() {
    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }
        
        const response = await fetch(`${API_URL}/medications`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to load medications');
        medications = await response.json();
        
        displayMedications();
        updateDashboardStats();
        
        // Show/hide empty state
        if (medications.length === 0) {
            document.getElementById('emptyMedications').style.display = 'block';
            document.getElementById('medicationsTable').style.display = 'none';
        } else {
            document.getElementById('emptyMedications').style.display = 'none';
            document.getElementById('medicationsTable').style.display = 'table';
        }
        
        return medications;
    } catch (error) {
        console.error('Error:', error);
        
        // หากพบ error 401 ให้นำผู้ใช้ไปยังหน้าล็อกอิน
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return [];
        }
        
        showAlert('error', 'ไม่สามารถโหลดข้อมูลยาได้');
        return [];
    } finally {
        hideLoader();
    }
}

async function loadMedicationLogs() {
    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }
        
        const response = await fetch(`${API_URL}/logs`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to load medication logs');
        medicationLogs = await response.json();
        updateDashboardStats();
        return medicationLogs;
    } catch (error) {
        console.error('Error:', error);
        
        // หากพบ error 401 ให้นำผู้ใช้ไปยังหน้าล็อกอิน
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return [];
        }
        
        showAlert('error', 'ไม่สามารถโหลดประวัติการใช้ยาได้');
        return [];
    } finally {
        hideLoader();
    }
}
// Alternative approach: Delete the old record and create a new one instead of updating
async function saveMedication() {
    // Get user_id from localStorage
    let userId = null;
    try {
        const userJson = localStorage.getItem('medicareUser');
        if (userJson) {
            const user = JSON.parse(userJson);
            if (user && user.id) {
                userId = user.id;
            }
        }
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึง user ID:', error);
    }

    // Check if user_id exists
    if (!userId) {
        showAlert('error', 'ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
        return;
    }

    // Get values from form
    const medId = document.getElementById('medId').value;
    const name = document.getElementById('medName').value.trim();
    const dosage = document.getElementById('medDosage').value.trim();
    const instructions = document.getElementById('medInstructions').value.trim();
    const time = document.getElementById('medTime').value.trim();

    // Validate required fields
    if (!name) {
        showAlert('error', 'กรุณากรอกชื่อยา');
        return;
    }

    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }

        // If we're updating an existing medication (edit mode)
        if (medId) {
            // Convert medId to a number
            const numericMedId = parseInt(medId, 10);
            if (isNaN(numericMedId)) {
                throw new Error('รหัสยาไม่ถูกต้อง');
            }
            
            console.log(`กำลังใช้วิธีลบและสร้างใหม่แทนการอัพเดทยา ID: ${numericMedId}`);
            
            // STEP 1: DELETE the existing medication 
            const deleteResponse = await fetch(`${API_URL}/medications/${numericMedId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!deleteResponse.ok) {
                console.error('ไม่สามารถลบข้อมูลยาเดิมได้:', deleteResponse.status);
                // Continue anyway - we'll try to create a new record
            } else {
                console.log('ลบข้อมูลยาเดิมสำเร็จ');
            }
        }
        
        // STEP 2: CREATE a new medication record
        // Prepare payload for creating a new record
        const payload = {
            name: name,
            dosage: dosage || null,
            usage_instructions: instructions || null,
            time_to_take: time || null,
            user_id: userId
        };

        console.log('ข้อมูลที่จะส่งในการสร้างยาใหม่:', payload);

        // Create a new medication record
        const createResponse = await fetch(`${API_URL}/medications`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });

        // Log the create response
        console.log('สถานะการตอบกลับ (สร้างใหม่):', createResponse.status);
        const responseText = await createResponse.text();
        console.log('ข้อความตอบกลับดิบ:', responseText);
        
        // Try to parse JSON response
        let responseData;
        try {
            responseData = JSON.parse(responseText);
            console.log('ข้อมูลตอบกลับแบบ JSON:', responseData);
        } catch (e) {
            console.warn('การตอบกลับไม่ใช่ JSON ที่ถูกต้อง:', e);
        }

        // Check if create was successful
        if (!createResponse.ok) {
            const errorMsg = responseData && responseData.message 
                ? responseData.message 
                : 'เกิดข้อผิดพลาดในการบันทึกข้อมูลยา';
            throw new Error(errorMsg);
        }
        
        // Refresh medication list
        await loadMedications();
        
        // Hide the form
        toggleForm('medicationForm');
        
        // Show success message
        showAlert('success', medId ? 'แก้ไขข้อมูลยาสำเร็จ' : 'บันทึกข้อมูลยาสำเร็จ');
        
        // Clear the form for next use
        clearForm('medicationForm');
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการบันทึกข้อมูลยา:', error);
        
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        
        showAlert('error', error.message || 'ไม่สามารถบันทึกข้อมูลยาได้');
    } finally {
        hideLoader();
    }
}
// ตัวอย่างการแก้ไขฟังก์ชัน markAsTaken
async function markAsTaken(id) {
    console.log('กำลังบันทึกการทานยา รหัส:', id);
    
    if (!id) {
        showAlert('error', 'ไม่พบรหัสยาที่ต้องการบันทึก');
        return;
    }
    
    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }

        const response = await fetch(`${API_URL}/logs`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                medication_id: id
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'เกิดข้อผิดพลาดในการบันทึกการทานยา');
        }

        const responseData = await response.json();
        
        // เพิ่มบันทึกใหม่ลงในแคชท้องถิ่น
        if (medicationLogs && Array.isArray(medicationLogs)) {
            const newLog = {
                id: responseData.data?.id || Date.now(),
                medication_id: id,
                confirmed_at: responseData.data?.confirmed_at || new Date().toISOString(),
                medication_name: medications.find(med => med.id === id)?.name || 'ไม่ระบุชื่อยา'
            };
            
            medicationLogs.push(newLog);
        }
        
        // อัปเดต UI
        updateDashboardStats();
        updateMedicationStatus(id);
        
        showAlert('success', 'บันทึกการทานยาสำเร็จ');
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการบันทึกการทานยา:', error);
        showAlert('error', error.message || 'ไม่สามารถบันทึกการทานยาได้');
    } finally {
        hideLoader();
    }
}
async function deleteMedication(id) {
    if (!confirm('คุณแน่ใจหรือว่าต้องการลบรายการยานี้?')) return;

    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }
        
        const response = await fetch(`${API_URL}/medications/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('Failed to delete medication');

        await loadMedications();
        showAlert('success', 'ลบรายการยาสำเร็จ');
    } catch (error) {
        console.error('Error:', error);
        
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        
        showAlert('error', 'ไม่สามารถลบรายการยาได้');
    } finally {
        hideLoader();
    }
}

    function getStatusForMedication(medicationId) {
        if (!medicationLogs || !Array.isArray(medicationLogs)) {
            return 'pending';
        }
        
        const today = new Date().toISOString().split('T')[0];
        const takenToday = medicationLogs.some(log => 
            log && log.medication_id === medicationId && 
            ((log.created_at && log.created_at.startsWith(today)) || 
            (log.confirmed_at && log.confirmed_at.startsWith(today)))
        );
        
        return takenToday ? 'taken' : 'pending';
    }

    function displayMedications() {
        const tbody = document.getElementById('medicationList');
        if (!tbody) {
            console.error('Element with ID "medicationList" not found');
            return;
        }
        
        tbody.innerHTML = '';

        if (!medications || !Array.isArray(medications)) {
            console.error('Medications is not defined or not an array');
            return;
        }

        medications.forEach(med => {
            if (!med) return;
            
            const status = getStatusForMedication(med.id);
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${med.name || '-'}</td>
                <td>${med.dosage || '-'}</td>
                <td>${med.usage_instructions || '-'}</td>
                <td>${med.time_to_take || '-'}</td>
                <td>
                    <span class="status-badge status-${status}">
                        ${status === 'taken' ? 'ทานแล้ว' : 'รอทานยา'}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="edit-btn" onclick="editMedication(${med.id})">
                            <i class="fas fa-edit"></i> แก้ไข
                        </button>
                        <button class="taken-btn" data-med-id="${med.id}" 
                            onclick="markAsTaken(${med.id})"
                            ${status === 'taken' ? 'disabled style="background-color:#34a853;color:white;"' : ''}>
                            <i class="fas fa-check"></i> ${status === 'taken' ? 'ทานแล้ว' : 'ทานยา'}
                        </button>
                        <button class="delete-btn" onclick="deleteMedication(${med.id})">
                            <i class="fas fa-trash-alt"></i> ลบ
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function editMedication(id) {
    if (!id) {
        showAlert('error', 'ไม่พบรหัสยาที่ต้องการแก้ไข');
        return;
    }
    
    console.log('เริ่มการแก้ไขยา ID:', id);
    showLoader();
    
    try {
        // ตรวจสอบว่า id เป็นตัวเลข
        const numericId = parseInt(id, 10);
        if (isNaN(numericId)) {
            throw new Error('รหัสยาไม่ถูกต้อง');
        }
        
        // ใช้ข้อมูลที่มีอยู่แล้วแทนการเรียก API ซ้ำ
        const medication = medications.find(med => med.id === numericId);
        
        if (!medication) {
            console.error('ไม่พบข้อมูลยา ID:', numericId, 'ในรายการยา:', medications);
            throw new Error('ไม่พบข้อมูลยาที่ต้องการแก้ไข');
        }
        
        console.log('พบข้อมูลยาที่ต้องการแก้ไข:', medication);
        
        // ใส่ข้อมูลลงในฟอร์ม
        document.getElementById('medId').value = medication.id;
        document.getElementById('medName').value = medication.name || '';
        document.getElementById('medDosage').value = medication.dosage || '';
        document.getElementById('medInstructions').value = medication.usage_instructions || '';
        document.getElementById('medTime').value = medication.time_to_take || '';
        
        // เปลี่ยนข้อความปุ่มบันทึก
        document.getElementById('saveMedButton').innerHTML = '<i class="fas fa-save"></i> อัพเดตข้อมูล';
        
        // แสดงฟอร์ม
        toggleForm('medicationForm');
        
        console.log('เปิดฟอร์มแก้ไขเรียบร้อย');
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการแก้ไขยา:', error);
        showAlert('error', error.message || 'ไม่สามารถโหลดข้อมูลยาได้');
    } finally {
        hideLoader();
    }
}

    async function markAsTaken(id) {
    console.log('กำลังบันทึกการทานยา รหัส:', id);
    
    if (!id) {
        showAlert('error', 'ไม่พบรหัสยาที่ต้องการบันทึก');
        return;
    }
    
    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }

        const response = await fetch(`${API_URL}/logs`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                medication_id: id
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'เกิดข้อผิดพลาดในการบันทึกการทานยา');
        }

        const responseData = await response.json();
        
        // เพิ่มบันทึกใหม่ลงในแคชท้องถิ่น
        if (medicationLogs && Array.isArray(medicationLogs)) {
            const newLog = {
                id: responseData.data?.id || Date.now(),
                medication_id: id,
                confirmed_at: responseData.data?.confirmed_at || new Date().toISOString(),
                medication_name: medications.find(med => med.id === id)?.name || 'ไม่ระบุชื่อยา'
            };
            
            medicationLogs.push(newLog);
        }
        
        // อัปเดต UI
        updateDashboardStats();
        updateMedicationStatus(id);
        
        showAlert('success', 'บันทึกการทานยาสำเร็จ');
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการบันทึกการทานยา:', error);
        
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        
        showAlert('error', error.message || 'ไม่สามารถบันทึกการทานยาได้');
    } finally {
        hideLoader();
    }
}
    // เพิ่มฟังก์ชันใหม่สำหรับอัปเดตแถวเฉพาะที่มีการเปลี่ยนแปลง
    function updateMedicationStatus(medicationId) {
        const button = document.querySelector(`button[data-med-id="${medicationId}"]`);
        if (!button) {
            console.error(`Button with data-med-id="${medicationId}" not found`);
            return;
        }
        
        const row = button.closest('tr');
        if (!row) {
            console.error('Could not find parent row');
            return;
        }
        
        // อัปเดตแถบสถานะ
        const statusCell = row.querySelector('td:nth-child(5)');
        if (statusCell) {
            statusCell.innerHTML = `
                <span class="status-badge status-taken">
                    ทานแล้ว
                </span>
            `;
        }
        
        // อัปเดตปุ่ม
        button.innerHTML = '<i class="fas fa-check"></i> ทานแล้ว';
        button.style.backgroundColor = "#34a853"; // สีเขียว
        button.style.color = "white";
        button.disabled = true;
    }

    // Reminders Functions
    async function loadReminders() {
    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }
        
        const response = await fetch(`${API_URL}/reminders`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to load reminders');
        reminders = await response.json();
        
        displayReminders();
        updateDashboardStats();
        
        // Show/hide empty state
        if (reminders.length === 0) {
            document.getElementById('emptyReminders').style.display = 'block';
            document.getElementById('remindersTable').style.display = 'none';
        } else {
            document.getElementById('emptyReminders').style.display = 'none';
            document.getElementById('remindersTable').style.display = 'table';
        }
        
        return reminders;
    } catch (error) {
        console.error('Error:', error);
        
        // หากพบ error 401 ให้นำผู้ใช้ไปยังหน้าล็อกอินใหม่
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return [];
        }
        
        showAlert('error', 'ไม่สามารถโหลดข้อมูลการแจ้งเตือนได้');
        return [];
    } finally {
        hideLoader();
    }
}
async function saveReminder() {
    const medicationId = document.getElementById('reminderMedication').value;
    const time = document.getElementById('reminderTime').value;
    const channel = "application"; // กำหนดค่าคงที่เพื่อหลีกเลี่ยงปัญหา truncation
    
    // ตรวจสอบข้อมูลให้ถูกต้อง
    if (!medicationId) {
        showAlert('error', 'กรุณาเลือกยาที่ต้องการแจ้งเตือน');
        return;
    }
    
    if (!time) {
        showAlert('error', 'กรุณาระบุเวลาแจ้งเตือน');
        return;
    }

    showLoader();
    try {
        console.log('กำลังส่งข้อมูล:', {
            medication_id: parseInt(medicationId), // แปลงเป็นตัวเลขชัดเจน
            reminder_time: time,
            notification_channel: channel
        });
        
        const response = await fetch(`${API_URL}/reminders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // เพิ่ม Authorization header ถ้าจำเป็น
                'Authorization': `Bearer ${localStorage.getItem('medicareToken')}`
            },
            body: JSON.stringify({
                medication_id: parseInt(medicationId), // แปลงเป็นตัวเลขชัดเจน
                reminder_time: time,
                notification_channel: channel
            })
        });

        // เพิ่มการตรวจสอบ response ละเอียดขึ้น
        const responseData = await response.json();
        console.log('ผลตอบกลับจาก API:', responseData);
        
        if (!response.ok) {
            throw new Error(responseData.message || 'ไม่สามารถบันทึกการแจ้งเตือนได้');
        }

        await loadReminders();
        toggleForm('reminderForm');
        showAlert('success', 'บันทึกการแจ้งเตือนสำเร็จ');
        clearForm('reminderForm');
    } catch (error) {
        console.error('Error details:', error);
        showAlert('error', `ไม่สามารถบันทึกการแจ้งเตือนได้: ${error.message || 'โปรดลองอีกครั้ง'}`);
    } finally {
        hideLoader();
    }
}
async function deleteReminder(id) {
    if (!confirm('คุณแน่ใจหรือว่าต้องการลบการแจ้งเตือนนี้?')) return;

    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }
        
        console.log(`กำลังลบการแจ้งเตือน ID: ${id}`);
        
        // เช็คว่าการแจ้งเตือนยังมีอยู่ในรายการในแอปก่อน
        const reminderExists = reminders.some(reminder => reminder && reminder.id === id);
        if (!reminderExists) {
            console.warn(`ไม่พบการแจ้งเตือน ID: ${id} ในรายการแอป`);
            showAlert('error', 'ไม่พบข้อมูลการแจ้งเตือนที่ต้องการลบ');
            hideLoader();
            // รีเฟรชรายการเพื่ออัปเดต UI
            await loadReminders();
            return;
        }
        
        // Check the correct API endpoint
        const url = `${API_URL}/reminders/${id}`;
        console.log(`ส่งคำขอไปยัง URL: ${url}`);
        
        const response = await fetch(url, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        // Log response details
        console.log('สถานะการตอบกลับ:', response.status);
        
        // If we get 404, it means the endpoint is wrong or the reminder doesn't exist on the server
        if (response.status === 404) {
            console.warn('ไม่พบ endpoint หรือการแจ้งเตือนบนเซิร์ฟเวอร์');
            
            // Remove from local array even if server delete failed
            reminders = reminders.filter(reminder => reminder && reminder.id !== id);
            displayReminders();
            showAlert('success', 'ลบการแจ้งเตือนออกจากรายการแล้ว');
            return;
        }

        if (!response.ok) {
            let errorMessage = 'ไม่สามารถลบการแจ้งเตือนได้';
            try {
                const errorData = await response.json();
                if (errorData && errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (e) {
                // Ignore JSON parse errors
            }
            throw new Error(errorMessage);
        }

        // Remove from local array and update UI
        reminders = reminders.filter(reminder => reminder && reminder.id !== id);
        displayReminders();
        updateDashboardStats();
        
        showAlert('success', 'ลบการแจ้งเตือนสำเร็จ');
    } catch (error) {
        console.error('Error:', error);
        
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        
        showAlert('error', error.message || 'ไม่สามารถลบการแจ้งเตือนได้');
    } finally {
        hideLoader();
    }
}
    function displayReminders() {
        const tbody = document.getElementById('reminderList');
        if (!tbody) {
            console.error('Element with ID "reminderList" not found');
            return;
        }
        
        tbody.innerHTML = '';

        if (!reminders || !Array.isArray(reminders)) {
            console.error('Reminders is not defined or not an array');
            return;
        }

        reminders.forEach(reminder => {
            if (!reminder) return;
            
            const row = document.createElement('tr');
            const medication = medications && Array.isArray(medications) ? 
                medications.find(med => med && med.id === reminder.medication_id) : null;
            
            row.innerHTML = `
                <td>${medication ? medication.name : 'ไม่พบข้อมูลยา'}</td>
                <td>${reminder.reminder_time || '-'}</td>
                <td>${reminder.notification_channel || '-'}</td>
                <td>
                    <button class="delete-btn" onclick="deleteReminder(${reminder.id})"><i class="fas fa-trash-alt"></i> ลบ</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

async function loadMedications() {
    showLoader();
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
        }
        
        console.log('กำลังโหลดข้อมูลยา...');
        
        const response = await fetch(`${API_URL}/medications`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('การตอบกลับไม่สำเร็จ:', response.status, errorText);
            throw new Error('ไม่สามารถโหลดข้อมูลยาได้');
        }
        
        const responseData = await response.json();
        console.log('โหลดข้อมูลยาสำเร็จ, จำนวน:', responseData.length);
        medications = responseData;
        
        displayMedications();
        updateDashboardStats();
        
        // Show/hide empty state
        if (medications.length === 0) {
            document.getElementById('emptyMedications').style.display = 'block';
            document.getElementById('medicationsTable').style.display = 'none';
        } else {
            document.getElementById('emptyMedications').style.display = 'none';
            document.getElementById('medicationsTable').style.display = 'table';
        }
        
        return medications;
    } catch (error) {
        console.error('Error:', error);
        
        // หากพบ error 401 ให้นำผู้ใช้ไปยังหน้าล็อกอิน
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('medicareToken');
            localStorage.removeItem('medicareUser');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return [];
        }
        
        showAlert('error', 'ไม่สามารถโหลดข้อมูลยาได้: ' + error.message);
        return [];
    } finally {
        hideLoader();
    }
}
    async function fetchMedicationUsageData() {
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            console.warn('ไม่พบ token สำหรับการเรียก API');
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ');
        }

        try {
            // พยายามเรียกข้อมูลจาก API ก่อน
            const response = await fetch(`${API_URL}/medications/usage`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                return await response.json();
            }
            
            // ตรวจสอบการตอบกลับ 401
            if (response.status === 401) {
                throw new Error('Unauthorized');
            }
        } catch (apiError) {
            console.warn('ไม่สามารถเรียกข้อมูลจาก API ได้:', apiError);
            
            if (apiError.message.includes('401') || apiError.message.includes('Unauthorized')) {
                showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
                localStorage.removeItem('medicareToken');
                localStorage.removeItem('medicareUser');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return [];
            }
        }
        
        // ถ้า API ไม่ตอบสนอง ให้สร้างข้อมูลจากข้อมูลยาที่มีอยู่ในแอป
        console.log('สร้างข้อมูลการใช้ยาตามเวลาจากข้อมูลในแอป');
        
        // จัดกลุ่มยาตามเวลาที่ต้องทาน
        const timeGroups = {};
        
        if (medications && Array.isArray(medications) && medications.length > 0) {
            medications.forEach(med => {
                if (!med) return;
                
                // ดึงเวลาเฉพาะส่วน HH:MM
                const timeToTake = med.time_to_take 
                    ? med.time_to_take.substring(0, 5) 
                    : 'ไม่ระบุเวลา';
                
                timeGroups[timeToTake] = (timeGroups[timeToTake] || 0) + 1;
            });
        }
        
        // แปลงเป็นรูปแบบที่ใช้สำหรับกราฟ
        return Object.keys(timeGroups).map(time => ({
            time_to_take: time,
            count: timeGroups[time]
        }));
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึงข้อมูลการใช้ยาตามเวลา:', error);
        return [];
    }
}
// ฟังก์ชันสำหรับดึงข้อมูลอัตราการทานยาวันนี้
async function fetchAdherenceData() {
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            console.warn('ไม่พบ token สำหรับการเรียก API');
        }

        try {
            // พยายามดึงข้อมูลจาก API ก่อน
            const response = await fetch(`${API_URL}/adherence/today`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                return await response.json();
            }
        } catch (apiError) {
            console.warn('ไม่สามารถเรียกข้อมูลจาก API ได้:', apiError);
        }
        
        // คำนวณข้อมูลเองจากข้อมูลในแอป
        console.log('คำนวณอัตราการทานยาจากข้อมูลในแอป');
        
        const today = new Date().toISOString().split('T')[0];
        const totalMeds = medications ? medications.length : 0;
        
        // นับจำนวนยาที่ทานวันนี้ (ยาที่มีบันทึกในวันนี้)
        let takenToday = 0;
        
        if (medicationLogs && Array.isArray(medicationLogs)) {
            // สร้างเซ็ตของ medication_id ที่มีการบันทึกวันนี้
            const takenMedIds = new Set();
            
            medicationLogs.forEach(log => {
                if (!log) return;
                
                const logDate = log.confirmed_at ? log.confirmed_at.split('T')[0] : 
                               (log.created_at ? log.created_at.split('T')[0] : null);
                
                if (logDate === today && log.medication_id) {
                    takenMedIds.add(log.medication_id);
                }
            });
            
            takenToday = takenMedIds.size;
        }
        
        // ตรวจสอบว่า takenToday ไม่เกิน totalMeds
        takenToday = Math.min(takenToday, totalMeds);
        
        return {
            total: totalMeds,
            taken: takenToday,
            pending: totalMeds - takenToday,
            adherenceRate: totalMeds > 0 ? (takenToday / totalMeds) * 100 : 0
        };
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการคำนวณอัตราการทานยา:', error);
        return {
            total: 0,
            taken: 0,
            pending: 0,
            adherenceRate: 0
        };
    }
}
// ฟังก์ชันสำหรับดึงข้อมูลการทานยา 7 วันย้อนหลัง
async function fetchDailyLogsData() {
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            console.warn('ไม่พบ token สำหรับการเรียก API');
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ');
        }

        try {
            // พยายามดึงข้อมูลจาก API ก่อน
            const response = await fetch(`${API_URL}/logs/daily`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                // แปลงวันที่เป็นชื่อวัน
                const data = await response.json();
                return data.map(item => {
                    const date = new Date(item.date);
                    return {
                        ...item,
                        name: formatThaiDay(date)
                    };
                });
            }
            
            // ตรวจสอบการตอบกลับ 401
            if (response.status === 401) {
                throw new Error('Unauthorized');
            }
        } catch (apiError) {
            console.warn('ไม่สามารถเรียกข้อมูลจาก API ได้:', apiError);
            
            if (apiError.message.includes('401') || apiError.message.includes('Unauthorized')) {
                showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
                localStorage.removeItem('medicareToken');
                localStorage.removeItem('medicareUser');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return [];
            }
        }
        
        // คำนวณข้อมูลเองจากข้อมูลในแอป
        console.log('คำนวณข้อมูลการทานยา 7 วันย้อนหลังจากข้อมูลในแอป');
        
        const result = [];
        
        // สร้างข้อมูลสำหรับ 7 วันย้อนหลัง
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            
            const dateString = date.toISOString().split('T')[0];
            
            // นับจำนวนยาที่ทานในวันนี้
            const takenMedIds = new Set();
            
            if (medicationLogs && Array.isArray(medicationLogs)) {
                medicationLogs.forEach(log => {
                    if (!log) return;
                    
                    const logDate = log.confirmed_at ? log.confirmed_at.split('T')[0] : 
                                   (log.created_at ? log.created_at.split('T')[0] : null);
                    
                    if (logDate === dateString && log.medication_id) {
                        takenMedIds.add(log.medication_id);
                    }
                });
            }
            
            result.push({
                date: dateString,
                name: formatThaiDay(date),
                count: takenMedIds.size
            });
        }
        
        return result;
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึงข้อมูลการทานยา 7 วันย้อนหลัง:', error);
        return [];
    }
}
// ฟังก์ชันช่วยสำหรับแปลงวันที่เป็นชื่อวันภาษาไทยแบบสั้น
function formatThaiDay(date) {
    const thaiDays = ['อา.', 'จ.', 'อ.', 'พ.', 'พฤ.', 'ศ.', 'ส.'];
    return thaiDays[date.getDay()];
}
// ฟังก์ชันสร้างกราฟแสดงการกระจายตัวของยาตามเวลา
function createTimeDistributionChart(data) {
    const ctx = document.getElementById('timeDistributionChart');
    if (!ctx) {
        console.error('ไม่พบ canvas element สำหรับกราฟการกระจายตัวของยาตามเวลา');
        return;
    }
    
    // ล้างกราฟเดิมถ้ามี
    if (window.timeDistributionChart instanceof Chart) {
        window.timeDistributionChart.destroy();
    }
    
    // ตรวจสอบข้อมูล
    if (!data || !Array.isArray(data) || data.length === 0) {
        // สร้างข้อความแสดงว่าไม่มีข้อมูล
        ctx.height = 150;
        const ctxContext = ctx.getContext('2d');
        ctxContext.clearRect(0, 0, ctx.width, ctx.height);
        ctxContext.font = '16px Sarabun';
        ctxContext.textAlign = 'center';
        ctxContext.textBaseline = 'middle';
        ctxContext.fillStyle = '#757575';
        ctxContext.fillText('ไม่มีข้อมูลการใช้ยา', ctx.width / 2, ctx.height / 2);
        return;
    }
    
    // สร้างข้อมูลสำหรับกราฟ
    const labels = data.map(item => item.time_to_take);
    const values = data.map(item => item.count);
    
    // สร้างสีตามจำนวนข้อมูล
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#8AC249', '#EA526F', '#23CDFD', '#9ADCFF'
    ];
    
    // สร้างกราฟใหม่
    window.timeDistributionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.slice(0, labels.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            family: 'Sarabun'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            return `${label}: ${value} รายการยา`;
                        }
                    }
                }
            }
        }
    });
}
//ฟังก์ชันสร้างกราฟแสดงอัตราการทานยาวันนี้
function createAdherenceChart(data) {
    const ctx = document.getElementById('adherenceChart');
    if (!ctx) {
        console.error('ไม่พบ canvas element สำหรับกราฟอัตราการทานยา');
        return;
    }
    
    // ล้างกราฟเดิมถ้ามี
    if (window.adherenceChart instanceof Chart) {
        window.adherenceChart.destroy();
    }
    
    // อัปเดตข้อความแสดงอัตราการทานยา
    const adherenceRateElement = document.getElementById('adherenceRate');
    if (adherenceRateElement) {
        const rate = data && typeof data.adherenceRate === 'number' ? data.adherenceRate.toFixed(1) : '0';
        adherenceRateElement.textContent = `${rate}%`;
    }
    
    // ตรวจสอบข้อมูล
    if (!data || typeof data.total !== 'number' || data.total === 0) {
        // สร้างข้อความแสดงว่าไม่มีข้อมูล
        ctx.height = 150;
        const ctxContext = ctx.getContext('2d');
        ctxContext.clearRect(0, 0, ctx.width, ctx.height);
        ctxContext.font = '16px Sarabun';
        ctxContext.textAlign = 'center';
        ctxContext.textBaseline = 'middle';
        ctxContext.fillStyle = '#757575';
        ctxContext.fillText('ไม่มีข้อมูลการทานยาวันนี้', ctx.width / 2, ctx.height / 2);
        return;
    }
    
    // สร้างกราฟใหม่
    window.adherenceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ทานแล้ว', 'ยังไม่ได้ทาน'],
            datasets: [{
                data: [data.taken, data.pending],
                backgroundColor: ['#4CAF50', '#FFA726']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            family: 'Sarabun'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            return `${label}: ${value} รายการ`;
                        }
                    }
                }
            }
        }
    });
}
// 6. ฟังก์ชันสร้างกราฟแสดงแนวโน้มการทานยา 7 วันล่าสุด
function createDailyLogsChart(data) {
    const ctx = document.getElementById('dailyLogsChart');
    if (!ctx) {
        console.error('ไม่พบ canvas element สำหรับกราฟแนวโน้มการทานยา');
        return;
    }
    
    // ล้างกราฟเดิมถ้ามี
    if (window.dailyLogsChart instanceof Chart) {
        window.dailyLogsChart.destroy();
    }
    
    // ตรวจสอบข้อมูล
    if (!data || !Array.isArray(data) || data.length === 0) {
        // สร้างข้อความแสดงว่าไม่มีข้อมูล
        ctx.height = 150;
        const ctxContext = ctx.getContext('2d');
        ctxContext.clearRect(0, 0, ctx.width, ctx.height);
        ctxContext.font = '16px Sarabun';
        ctxContext.textAlign = 'center';
        ctxContext.textBaseline = 'middle';
        ctxContext.fillStyle = '#757575';
        ctxContext.fillText('ไม่มีข้อมูลการทานยาย้อนหลัง', ctx.width / 2, ctx.height / 2);
        return;
    }
    
    // สร้างกราฟใหม่
    window.dailyLogsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(item => item.name),
            datasets: [{
                label: 'จำนวนยาที่ทาน',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.1,
                fill: true,
                pointBackgroundColor: '#fff',
                pointBorderColor: 'rgba(54, 162, 235, 1)',
                pointBorderWidth: 2,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            family: 'Sarabun'
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            family: 'Sarabun'
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            family: 'Sarabun'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.raw;
                            return `${label}: ${value} รายการ`;
                        }
                    }
                }
            }
        }
    });
}

// 7. ฟังก์ชันหลักสำหรับแสดงกราฟทั้งหมดในแดชบอร์ด
async function renderDashboardCharts() {
    showLoader();
    
    try {
        console.log('เริ่มการแสดงผลกราฟในแดชบอร์ด');
        
        // ดึงข้อมูลทั้งหมดที่จำเป็นสำหรับกราฟ
        const [usageData, adherenceData, dailyLogsData] = await Promise.all([
            fetchMedicationUsageData(),
            fetchAdherenceData(),
            fetchDailyLogsData()
        ]);
        
        console.log('ข้อมูลการใช้ยาตามเวลา:', usageData);
        console.log('ข้อมูลอัตราการทานยา:', adherenceData);
        console.log('ข้อมูลการทานยา 7 วันล่าสุด:', dailyLogsData);
        
        // สร้างกราฟทั้งหมด
        createTimeDistributionChart(usageData);
        createAdherenceChart(adherenceData);
        createDailyLogsChart(dailyLogsData);
        
        console.log('สร้างกราฟในแดชบอร์ดเสร็จสมบูรณ์');
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการสร้างกราฟ:', error);
        
        // แสดงข้อความแจ้งเตือนกรณีเกิดข้อผิดพลาด
        showAlert('error', 'ไม่สามารถแสดงแผนภูมิได้ โปรดลองใหม่อีกครั้ง');
        
        // แสดงข้อความแจ้งเตือนในพื้นที่กราฟ
        ['timeDistributionChart', 'adherenceChart', 'dailyLogsChart'].forEach(chartId => {
            const canvas = document.getElementById(chartId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.height = 150;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Sarabun';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#757575';
                ctx.fillText('ไม่สามารถโหลดข้อมูลได้ โปรดลองใหม่', canvas.width / 2, canvas.height / 2);
            }
        });
    } finally {
        hideLoader();
    }
}

// เพิ่มการเรียกใช้งานเมื่อเปิดแท็บแดชบอร์ด
document.addEventListener('DOMContentLoaded', () => {
    // เลือกแท็บแดชบอร์ด
    const dashboardTab = document.querySelector('.tab[onclick="showSection(\'dashboard\')"]');
    if (dashboardTab) {
        dashboardTab.addEventListener('click', () => {
            // รอให้ DOM อัปเดตก่อนแล้วค่อยเรนเดอร์กราฟ
            setTimeout(renderDashboardCharts, 100);
        });
    }
    
    // ตรวจสอบหากแท็บแดชบอร์ดเปิดอยู่ตั้งแต่เริ่มต้น
    if (document.getElementById('dashboardSection')?.classList.contains('active')) {
        setTimeout(renderDashboardCharts, 500);
    }
});
async function fetchAdherenceData() {
    try {
        const token = localStorage.getItem('medicareToken');
        if (!token) {
            console.warn('ไม่พบ token สำหรับการเรียก API');
            throw new Error('ไม่พบข้อมูลการเข้าสู่ระบบ');
        }

        try {
            // พยายามดึงข้อมูลจาก API ก่อน
            const response = await fetch(`${API_URL}/adherence/today`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                return await response.json();
            }
            
            // ตรวจสอบการตอบกลับ 401
            if (response.status === 401) {
                throw new Error('Unauthorized');
            }
        } catch (apiError) {
            console.warn('ไม่สามารถเรียกข้อมูลจาก API ได้:', apiError);
            
            if (apiError.message.includes('401') || apiError.message.includes('Unauthorized')) {
                showAlert('error', 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
                localStorage.removeItem('medicareToken');
                localStorage.removeItem('medicareUser');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return { total: 0, taken: 0, pending: 0, adherenceRate: 0 };
            }
        }
        
        // คำนวณข้อมูลเองจากข้อมูลในแอป
        console.log('คำนวณอัตราการทานยาจากข้อมูลในแอป');
        
        const today = new Date().toISOString().split('T')[0];
        const totalMeds = medications ? medications.length : 0;
        
        // นับจำนวนยาที่ทานวันนี้ (ยาที่มีบันทึกในวันนี้)
        let takenToday = 0;
        
        if (medicationLogs && Array.isArray(medicationLogs)) {
            // สร้างเซ็ตของ medication_id ที่มีการบันทึกวันนี้
            const takenMedIds = new Set();
            
            medicationLogs.forEach(log => {
                if (!log) return;
                
                const logDate = log.confirmed_at ? log.confirmed_at.split('T')[0] : 
                               (log.created_at ? log.created_at.split('T')[0] : null);
                
                if (logDate === today && log.medication_id) {
                    takenMedIds.add(log.medication_id);
                }
            });
            
            takenToday = takenMedIds.size;
        }
        
        // ตรวจสอบว่า takenToday ไม่เกิน totalMeds
        takenToday = Math.min(takenToday, totalMeds);
        
        return {
            total: totalMeds,
            taken: takenToday,
            pending: totalMeds - takenToday,
            adherenceRate: totalMeds > 0 ? (takenToday / totalMeds) * 100 : 0
        };
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการคำนวณอัตราการทานยา:', error);
        return {
            total: 0,
            taken: 0,
            pending: 0,
            adherenceRate: 0
        };
    }
}


    </script>
</body>
</html>